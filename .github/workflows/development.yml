# Development Branch CI Workflow
# Uses semantic-release to determine version based on commit messages
# Creates alpha pre-releases: 4.1.2-alpha.1, 4.1.2-alpha.2, etc.
#
# Commit types:
#   feat!: â†’ major bump (breaking change)
#   feat:  â†’ minor bump
#   fix:   â†’ patch bump
#   refactor: / perf: â†’ patch bump
#   chore: / docs: â†’ no release

name: Development CI

on:
  push:
    branches:
      - development
      - main # For backward compatibility

  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Setup git branch
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "Setting up branch: $BRANCH_NAME"
          git checkout -B "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          git branch --set-upstream-to=origin/"$BRANCH_NAME" "$BRANCH_NAME" || true
          echo "Current branch: $(git branch --show-current)"
          echo "Git status:"
          git status

      - name: Verify branch context
        run: |
          echo "GitHub ref: ${{ github.ref }}"
          echo "GitHub ref name: ${{ github.ref_name }}"
          echo "Current branch: $(git branch --show-current)"
          echo "Recent tags:"
          git tag --sort=-v:refname | head -10

      - name: Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: semantic-release[bot]
          GIT_AUTHOR_EMAIL: semantic-release[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: semantic-release[bot]
          GIT_COMMITTER_EMAIL: semantic-release[bot]@users.noreply.github.com
        run: |
          echo "Running semantic-release on branch: ${{ github.ref_name }}"
          npx semantic-release --debug

      - name: Get new version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New version: $VERSION"

      - name: Calculate build number
        id: build
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Remove prerelease suffix if present (e.g., 4.1.2-alpha.1 -> 4.1.2)
          CLEAN_VERSION=$(echo "$VERSION" | sed 's/-.*//')
          
          # Split version into parts
          MAJOR=$(echo "$CLEAN_VERSION" | cut -d. -f1)
          MINOR=$(echo "$CLEAN_VERSION" | cut -d. -f2)
          PATCH=$(echo "$CLEAN_VERSION" | cut -d. -f3)
          
          # Calculate build number: MMNNPP0000 format
          BUILD_NUMBER=$(printf "%d%02d%02d0000" "$MAJOR" "$MINOR" "$PATCH")
          
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ”¢ Build number: $BUILD_NUMBER (from version $VERSION)"

      - name: Display release info
        run: |
          echo "âœ… Release Summary"
          echo "=================="
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Build Number: ${{ steps.build.outputs.build_number }}"
          echo "Branch: development (alpha)"
          echo "Pre-release: Yes"
